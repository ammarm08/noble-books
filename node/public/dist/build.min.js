/*! noble-books 05-08-2016 */
!function(){$(document).ready(function(){function a(){Z.age_filter.tooltip(),Z.length_filter.tooltip(),$(".books-list span").tooltip()}function b(){Z.search.mouseup(q),Z.age_filter.on("click",t),Z.genre_filter.on("click",u),Z.length_filter.on("click",s),Z.advanced_toggle.on("click",i),Z.search.on("click",j),Z.sorts.on("click",k),Z.book.on("click",S)}function c(a){$.ajax({type:"GET",url:"/api/books?sort="+Y.sort,success:a})}function d(a){Y.store.all=a,Y.store.selected=Y.store.all,f(),J(Y.store.selected),I(),Y.page++}function e(a){Z.books_list.empty(),Y.store.all=a,Y.store.selected=Y.store.all,G(Y.page,Y.store.selected),Y.page++}function f(){Z.book.each(function(a){var b=$(this);g(b,a),h(b,a)})}function g(a,b){var c=Y.store.selected[b];a.data("book-title",c.title),a.data("book-author",c.author),a.data("book-summary",c.summary),a.data("book-link",c.link),a.data("book-year",c.year),a.data("book-genre",c.genre),a.data("book-reviews",c.reviews),a.data("book-recommenders",c.recommenders),a.data("book-length",c.length),a.data("book-thumbnails",c.thumbnails)}function h(a,b){var c=Y.store.selected[b];a.find(".img-circle").each(function(a){var b=c.reviews[a],d=c.recommenders[a],e='""'===b?d:d+": "+b;$(this).attr("title",e),$(this).tooltip()})}function i(a){a.preventDefault(),$(".advanced-filter:visible").length?(Z.advanced_filter.hide(),Z.advanced_toggle.text("Advanced Filters")):(Z.advanced_filter.show(),Z.advanced_toggle.text("Hide Filters")),q()}function j(a){l(),Y.store.selected=m(),G(Y.page,Y.store.selected),B(),Y.page++}function k(a){a.preventDefault(),l(),Y.sort=$(this).data("sort");var b=$('[data-sort="'+Y.sort+'"]').text();$("#current-sort").text("Sort By: "+b),c(e)}function l(){Z.books_list.empty(),Y.page=0}function m(){return Y.store.all.filter(function(a){return n(a.genre)&&o(a.length)&&p(a.year)})}function n(a){return Y.store.genres.indexOf(a)!==-1}function o(a){return Y.store.lengths.indexOf("short")!==-1&&a<150||(Y.store.lengths.indexOf("medium")!==-1&&a>150&&a<400||Y.store.lengths.indexOf("long")!==-1&&a>400)}function p(a){return Y.store.ages.indexOf(1900)!==-1&&a<1900||(Y.store.ages.indexOf(1901)!==-1&&a>=1900&&a<2e3||Y.store.ages.indexOf(2e3)!==-1&&a>=2e3)}function q(a){$(this).blur()}function r(a,b){return function(c){c.preventDefault(),"all"===b.data(a).toString().toLowerCase()?w(a,b):b.hasClass("active")?x(a,b):y(a)?z(a):v(a,b),A()}}function s(a){r("length",$(this))(a)}function t(a){r("age",$(this))(a)}function u(a){r("genre",$(this))(a)}function v(a,b){switch(b.addClass("active"),a){case"length":$(".all_lengths").removeClass("active"),Y.store.lengths=F("length",$(".filter-by-length .active"));break;case"age":$(".all_ages").removeClass("active"),Y.store.ages=F("age",$(".filter-by-age .active"));break;case"genre":$(".all_genres").removeClass("active"),Y.store.genres=F("genre",$(".filter-by-genre .active"));break;default:v("length",b)}}function w(a,b){switch(a){case"length":C(Z.length_filter,b),Y.store.lengths=X.lengths;break;case"age":C(Z.age_filter,b),Y.store.ages=X.ages;break;case"genre":C(Z.genre_filter,b),Y.store.genres=X.genres;break;default:w("length",b)}}function x(a,b){switch(D(b),a){case"length":Y.store.lengths=E(Y.store.lengths,"length",b);break;case"age":Y.store.ages=E(Y.store.ages,"age",b);break;case"genre":Y.store.genres=E(Y.store.genres,"genre",b);break;default:x("length",b)}}function y(a){switch(a){case"length":return $(".filter-by-length .active").length>=2;case"age":return $(".filter-by-age .active").length>=2;case"genre":return $(".filter-by-genre .active").length>=6;default:y("length")}}function z(a){var b=".all_"+a+"s";$(b).trigger("click")}function A(){Z.search.hasClass("active")||Z.search.addClass("active")}function B(){Z.search.hasClass("active")&&Z.search.removeClass("active")}function C(a,b){a.removeClass("active"),b.addClass("active")}function D(a){a.removeClass("active"),a.blur()}function E(a,b,c){return a.filter(function(a){return a!==c.data(b)})}function F(a,b){return b.map(function(b,c){return $(this).data(a)}).toArray()}function G(a,b){var c=a*W.page_increment,d=W.page_increment+a*W.page_increment,e=b.slice(c,d);H(e),J(b)}function H(a){a.forEach(function(a,b){K(a,b)}),I()}function I(){if(0===$("#email-signup").length){var a=$('<a id="email-signup" class="list-group-item"> Get early access to new books and exclusive author interviews. </a>');a.attr("href","http://eepurl.com/b5XRYX"),a.attr("target","_blank"),$(".books-list li:eq(4)").after(a)}}function J(a){var b=a.length,c=L(b),d=$('<a class="next_results"></a>');d.text("More Results (viewing "+c+" of "+b+")"),d.click({book_data:a},M),Z.books_list.append(d)}function K(a,b){var c=$('<li class="list-group-item book-row" style="display: none"></li>'),d=$('<div class="book" data-toggle="modal" data-target="#bookModal"></div>'),e=$('<div class="book_title"></div>'),f=$('<div class="book_author"></div>');d.data("book-title",a.title),d.data("book-author",a.author),d.data("book-summary",a.summary),d.data("book-link",a.link),d.data("book-year",a.year),d.data("book-genre",a.genre),d.data("book-reviews",a.reviews),d.data("book-recommenders",a.recommenders),d.data("book-length",a.length),d.data("book-thumbnails",a.thumbnails),d.on("click",S),e.text(O(a.title)),f.text(a.author),d.append(e).append(f);var g=$('<div class="book_data"></div>'),h=$('<div class="book_genre">'+a.genre+"</div>"),i=$('<div class="book_length">'+a.length+" pages  ("+N(a.year)+")</div>");g.append(h).append(i);var j=$('<div class="book_recommenders"></div>');U(a,j),V(a,j),c.append(d).append(g).append(j),Z.books_list.append(c),c.fadeIn(1e3)}function L(a){return a<=W.page_increment+Y.page*W.page_increment?a:W.page_increment+Y.page*W.page_increment}function M(a){this.remove(),a.preventDefault(),G(Y.page,a.data.book_data),Y.page++}function N(a){return a<0?parseInt(Math.abs(a))+" BC":parseInt(a)<1400?parseInt(a)+" AD":a}function O(a){return a.length>50?a.slice(0,50)+"...":a}function P(a){for(var b=0,c=-1;b<a.length;){if('""'!==a[b]){c=b;break}b++}return c}function Q(a,b){var c=P(a),d=a[c],e=b[c],f=$("<div></div>");return d?f.text(d+" - "+e):f.text("None found."),f}function R(a,b){for(var c=0;c<a.length;c++){var d=$('<img class="img-circle"/>');d.data("toggle","tooltip"),d.attr("title","Recommended by "+a[c]),d.attr("src",b[c]),$(".modal-recommenders").append(d),d.tooltip()}}function S(a){$(".modal-review").empty(),$(".modal-recommenders").empty(),$(".modal-title").text($(this).data("book-title")),$(this).data("book-summary").length?$(".modal-about").text($(this).data("book-summary")):$(".modal-about").text("We don't have one yet in our system, but it'll be here soon! Help us out by suggesting an edit :)"),$(".modal-blurb").text($(this).data("book-author")),$(".get-book").attr("href",$(this).data("book-link")).attr("target","_blank"),$(".modal-image").attr("src","https://images-na.ssl-images-amazon.com/images/I/41YdCQ5bIAL.jpg"),$(".modal-year").text(N($(this).data("book-year"))),$(".modal-length").text($(this).data("book-length")+" pages"),$(".modal-genre").text($(this).data("book-genre"));var b=Q($(this).data("book-reviews"),$(this).data("book-recommenders"));$(".modal-review").append(b),R($(this).data("book-recommenders"),$(this).data("book-thumbnails")),$(this).data("book-link").indexOf("amazon.com")>-1&&T($(this).data("book-link"))}function T(a){$("#gr_add_to_books").empty();var b=$('<div class="gr_custom_each_container_"></div>'),c=$('<a target="_blank" style="border:none"></a>'),d=$("<script></script>"),e=a.split("/").pop(),f="?atmb_widget%5Bbutton%5D=atmb_widget_1.png&amp;atmb_widget%5Bhide_friends%5D=on",g="https://www.goodreads.com/book/add_to_books_widget_frame/"+e+f,h="https://www.goodreads.com/book/isbn/"+e;c.attr("href",h),d.attr("src",g),b.append(c),$("#gr_add_to_books").append(b).append(d)}function U(a,b){for(var c=0;c<a.recommenders.length;c++){var d=$('<img class="img-circle"/>'),e=a.recommenders[c],f='""'===a.reviews[c]?null:a.reviews[c].trim(),g=f?e+": "+f:e;d.data("toggle","tooltip"),d.attr("title",g),d.attr("src",a.thumbnails[c]),b.append(d),d.tooltip()}}function V(a,b){var c=$('<span><a href="#"></a></span>');c.addClass("glyphicon glyphicon-option-vertical"),c.data("toggle","tooltip"),c.attr("title",a.recommenders.join(", ")),c.tooltip(),b.append(c)}var W={page_increment:10},X={genres:$(".genre_filter").map(function(){return $(this).data("genre")}).toArray(),lengths:$(".filter-by-length button").map(function(){return $(this).data("length")}).toArray(),ages:$(".filter-by-age button").map(function(){return $(this).data("age")}).toArray()},Y={store:{all:[],selected:[],lengths:X.lengths,genres:X.genres,ages:X.ages},page:0,sort:"frequencies_title"},Z={books_list:$(".books-list"),book:$(".book-row"),advanced_toggle:$(".show-advanced"),advanced_filter:$(".advanced-filter"),search:$(".show-results"),age_filter:$(".age_filter"),genre_filter:$(".genre_filter"),length_filter:$(".length_filter"),sorts:$(".dropdown-item")};a(),b(),c(d)})}(),window.initThinkersPage=function(){$(document).ready(function(){function a(){$.ajax({type:"GET",url:"/api/recommenders",success:function(a){d=a,b()}})}function b(){$(".thumbnail-container").each(function(a){var b=$(this);b.data("recommended-books",d[a].recommended_books)})}function c(a){$(".modal-title").text($(this).data("name")+"'s Picks"),$(".modal-about").text($(this).data("name")+" "+$(this).data("bio")),$(".recommendations-container").empty();for(var b=$(this).data("recommended-books"),c=0;c<b.length;c++){var d=$("<div></div>"),e=$('<a class="list-group-item thumbnail recommendation"></a>'),f=$('<a class="glyphicon glyphicon-question-sign"></a>');e.text(b[c][0]),e.attr("href",b[c][1]),e.attr("target","_blank"),f.attr("title","Source"),f.attr("href",b[c][2]),f.attr("target","_blank"),f.data("toggle","tooltip"),f.tooltip(),d.append(e).append(f),$(".recommendations-container").append(d)}}var d=[];$(".recs");$(".thumbnail-container").on("click",c),a()})};